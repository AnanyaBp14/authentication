<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mocha~Mist ‚òÅÔ∏è | Customer Dashboard</title>

  <style>
    /* üî• KEEPING YOUR FULL CSS EXACTLY SAME ‚Äî NO CHANGES */
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap');

    * { margin:0; padding:0; box-sizing:border-box; font-family:Poppins; }

    body { background:#fbf7f1; color:#3c2f24; }

    header {
      display:flex; justify-content:space-between; align-items:center;
      background:#fff; padding:1rem 2rem;
      box-shadow:0 2px 6px rgba(0,0,0,0.05);
      position:sticky; top:0; z-index:10;
      border-bottom:2px solid #c49a6c;
    }

    .logo { font-weight:600; font-size:1.3rem; color:#6b4024; }

    nav { display:flex; gap:1.5rem; align-items:center; }
    nav a { cursor:pointer; text-decoration:none; color:#4c3a2f; font-weight:500; }
    nav a:hover { color:#c49a6c; }

    .cart-count {
      background:#6b4024; color:white; border-radius:50%;
      padding:2px 6px; font-size:0.75rem; margin-left:3px;
    }

    section { padding:2rem 3%; }

    .menu-grid {
      display:grid; grid-template-columns:repeat(auto-fit, minmax(250px,1fr));
      gap:1.7rem;
    }

    .coffee-card {
      background:#fff; border-radius:16px; overflow:hidden;
      box-shadow:0 4px 14px rgba(0,0,0,0.08);
      transition:0.3s ease;
    }
    .coffee-card:hover { transform:translateY(-5px); }

    .coffee-card img { width:100%; height:180px; object-fit:cover; }

    .coffee-card .details { padding:1rem; }
    .coffee-card h3 { font-size:1.1rem; display:flex; justify-content:space-between; }

    .coffee-card button {
      margin-top:0.8rem; width:100%; padding:0.6rem;
      background:#6b4024; color:white; border:none;
      border-radius:10px; cursor:pointer;
    }
    .coffee-card button:hover { background:#4b2b18; }

    .cart-container { display:flex; justify-content:space-between; gap:1.5rem; flex-wrap:wrap; }
    .cart-items { width:60%; display:flex; flex-direction:column; gap:1rem; }

    .cart-item {
      background:#fff; padding:1rem; border-radius:14px;
      display:flex; justify-content:space-between; align-items:center;
    }

    .order-summary {
      background:#fff; width:280px; padding:1.4rem;
      border-radius:14px; box-shadow:0 3px 12px rgba(0,0,0,0.07);
    }
    .order-summary button {
      width:100%; background:#6b4024; color:white;
      padding:0.8rem; border:none; border-radius:12px;
    }

    .order-card {
      background:#fff; padding:1.5rem; border-radius:14px;
      margin-bottom:1rem; box-shadow:0 3px 10px rgba(0,0,0,0.06);
    }

    .progress-container { height:6px; background:#e6ddd4; border-radius:4px; margin-top:.8rem; }
    .progress-bar { height:6px; background:linear-gradient(90deg,#6b4024,#c49a6c); width:0%; transition:0.8s; }
  </style>
</head>

<body>

  <header>
    <div class="logo">‚òï Mocha~Mist</div>
    <nav>
      <a onclick="showSection('menu')">Menu</a>
      <a onclick="showSection('cart')">Cart <span id="cartCount" class="cart-count">0</span></a>
      <a onclick="showSection('orders')">My Orders</a>
      <a onclick="logout()">Logout</a>
    </nav>
  </header>

  <!-- MENU -->
  <section id="menuSection">
    <h2>Our Menu</h2>
    <p class="subtitle">Explore our handcrafted beverages</p>
    <div id="menuGrid" class="menu-grid"></div>
  </section>

  <!-- CART -->
  <section id="cartSection" style="display:none;">
    <h2>Your Cart</h2>
    <div class="cart-container">
      <div id="cartItems" class="cart-items"></div>
      <div class="order-summary">
        <p>Subtotal: <span id="subtotal">‚Çπ0.00</span></p>
        <p>Tax (8%): <span id="tax">‚Çπ0.00</span></p>
        <p><strong>Total:</strong> <strong id="total">‚Çπ0.00</strong></p>
        <button onclick="placeOrder()">Place Order ‚ûú</button>
      </div>
    </div>
  </section>

  <!-- ORDERS -->
  <section id="ordersSection" style="display:none;">
    <h2>Order Tracking</h2>
    <p class="subtitle">Track your real-time order status</p>
  </section>

  <script src="https://mochamist.onrender.com/socket.io/socket.io.js"></script>

  <!-- ‚≠ê REAL BACKEND-CONNECTED LOGIC -->
  <script>
  const API = "https://mochamist.onrender.com";
  const token = localStorage.getItem("accessToken");
  const userId = localStorage.getItem("userId");

  if (!token) location.href = "index.html";

  const socket = io(API, { transports: ["websocket"] });
  socket.emit("join", "user_" + userId);

  let cart = [];
  let myOrders = [];

  const menuGrid = document.getElementById("menuGrid");
  const cartItems = document.getElementById("cartItems");
  const cartCount = document.getElementById("cartCount");

  /* ---------------- LOAD MENU ---------------- */
  async function loadMenu() {
    const r = await fetch(`${API}/api/menu`);
    const menu = await r.json();

    menuGrid.innerHTML = "";
    menu.forEach(item => {
      menuGrid.innerHTML += `
        <div class="coffee-card">
          <img src="${item.img || 'https://via.placeholder.com/300'}">
          <div class="details">
            <h3>${item.name} <span>‚Çπ${item.price}</span></h3>
            <p>${item.description || ""}</p>
            <button onclick="addToCart(${item.id}, '${item.name}', ${item.price})">Add to Cart</button>
          </div>
        </div>`;
    });
  }

  /* ---------------- CART ---------------- */
  function addToCart(id, name, price) {
    const found = cart.find(c => c.id === id);
    if (found) found.qty++;
    else cart.push({ id, name, price, qty: 1 });
    updateCart();
  }

  function updateCart() {
    cartItems.innerHTML = "";
    cartCount.textContent = cart.reduce((a, b) => a + b.qty, 0);
    let subtotal = 0;

    cart.forEach((it, i) => {
      subtotal += it.qty * it.price;
      cartItems.innerHTML += `
        <div class="cart-item">
          <div>
            <h4>${it.name}</h4>
            <p>‚Çπ${it.price}</p>
            <div>
              <button onclick="changeQty(${i}, -1)">‚àí</button>
              ${it.qty}
              <button onclick="changeQty(${i}, 1)">+</button>
            </div>
          </div>
          <strong>‚Çπ${(it.qty * it.price).toFixed(2)}</strong>
          <button onclick="removeItem(${i})">üóëÔ∏è</button>
        </div>`;
    });

    const tax = subtotal * 0.08;
    document.getElementById("subtotal").textContent = `‚Çπ${subtotal.toFixed(2)}`;
    document.getElementById("tax").textContent = `‚Çπ${tax.toFixed(2)}`;
    document.getElementById("total").textContent = `‚Çπ${(subtotal + tax).toFixed(2)}`;
  }

  function changeQty(i, v) {
    cart[i].qty += v;
    if (cart[i].qty <= 0) cart.splice(i, 1);
    updateCart();
  }

  function removeItem(i) {
    cart.splice(i, 1);
    updateCart();
  }

  /* ---------------- PLACE ORDER ---------------- */
  async function placeOrder() {
    if (cart.length === 0) return alert("Your cart is empty!");

    const items = cart.map(i => ({
      id: i.id,
      name: i.name,
      qty: i.qty,
      price: i.price
    }));

    const total = cart.reduce((a, b) => a + b.qty * b.price, 0);

    const r = await fetch(`${API}/api/orders/create`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: "Bearer " + token,
      },
      body: JSON.stringify({ items, total })
    });

    const data = await r.json();

    if (!r.ok) return alert(data.message);

    alert("Order placed!");
    cart = [];
    updateCart();
    showSection("orders");
    loadMyOrders();
  }

  /* ---------------- LOAD MY ORDERS ---------------- */
  async function loadMyOrders() {
    const r = await fetch(`${API}/api/orders/mine`, {
      headers: { Authorization: "Bearer " + token }
    });

    const orders = await r.json();
    const ordersSection = document.getElementById("ordersSection");

    ordersSection.innerHTML = `<h2>Order Tracking</h2>`;

    orders.forEach(order => {
      ordersSection.innerHTML += `
      <div class="order-card">
        <strong>Order #${order.id}</strong>
        <span style="float:right">${order.status}</span>
        <p>${new Date(order.time).toLocaleString()}</p>
        <ul>${order.items.map(i => `<li>${i.name} √ó${i.qty}</li>`).join("")}</ul>
        <p><strong>Total:</strong> ‚Çπ${order.total}</p>
        <div class="progress-container">
          <div class="progress-bar" style="width:${
            order.status === "Preparing" ? "33%" :
            order.status === "Ready" ? "66%" :
            order.status === "Served" ? "100%" : "0%"
          }"></div>
        </div>
      </div>`;
    });
  }

  /* ---------------- SOCKET LISTENER ---------------- */
  socket.on("order:update", () => loadMyOrders());

  /* ---------------- SECTION SWITCH ---------------- */
  function showSection(s) {
    document.getElementById("menuSection").style.display = s === "menu" ? "block" : "none";
    document.getElementById("cartSection").style.display = s === "cart" ? "block" : "none";
    document.getElementById("ordersSection").style.display = s === "orders" ? "block" : "none";
    if (s === "orders") loadMyOrders();
  }

  function logout() {
    localStorage.clear();
    location.href = "index.html";
  }

  loadMenu();
  loadMyOrders();
  </script>

</body>
</html>
