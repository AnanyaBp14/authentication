<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mocha~Mist ‚òÅÔ∏è | Customer Dashboard</title>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap');

    * {
      margin: 0; padding: 0;
      box-sizing: border-box;
      font-family: "Poppins", sans-serif;
    }

    body {
      background-color: #fbf7f1;
      color: #3c2f24;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: #fff;
      padding: 1rem 2rem;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      position: sticky;
      top: 0;
      z-index: 10;
      border-bottom: 2px solid #c49a6c;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      font-weight: 600;
      color: #6b4024;
      font-size: 1.3rem;
    }

    nav {
      display: flex;
      gap: 1.5rem;
      align-items: center;
    }

    nav a {
      text-decoration: none;
      color: #4c3a2f;
      font-weight: 500;
      cursor: pointer;
      transition: 0.25s ease;
    }

    nav a:hover {
      color: #c49a6c;
      transform: translateY(-2px);
    }

    .cart-count {
      background-color: #6b4024;
      color: white;
      border-radius: 50%;
      padding: 2px 6px;
      font-size: 0.75rem;
      margin-left: 3px;
    }

    section {
      padding: 2rem 3%;
      animation: fadeIn 0.6s ease;
    }

    h2 {
      font-size: 1.8rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: #6b4024;
    }

    p.subtitle {
      color: #8a7b6f;
      margin-bottom: 1.5rem;
    }

    /* MENU GRID */
    .menu-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.7rem;
    }

    .coffee-card {
      background: #fff;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 4px 14px rgba(0,0,0,0.08);
      transition: 0.3s ease;
    }

    .coffee-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 18px rgba(0,0,0,0.12);
    }

    .coffee-card img {
      width: 100%;
      height: 180px;
      object-fit: cover;
    }

    .coffee-card .details {
      padding: 1rem;
    }

    .coffee-card h3 {
      font-size: 1.1rem;
      display: flex;
      justify-content: space-between;
    }

    .coffee-card p {
      color: #7b6a58;
      font-size: 0.9rem;
      margin-top: 0.3rem;
    }

    .coffee-card button {
      width: 100%;
      margin-top: 0.8rem;
      background: #6b4024;
      border: none;
      color: #fff;
      padding: 0.6rem 0;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 500;
      transition: 0.3s ease;
    }

    .coffee-card button:hover {
      background: #4b2b18;
    }

    /* CART */
    .cart-container {
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 1.5rem;
    }

    .cart-items {
      width: 60%;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .cart-item {
      background: #fff;
      padding: 1rem;
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 3px 10px rgba(0,0,0,0.06);
    }

    .cart-item img {
      width: 70px;
      height: 70px;
      border-radius: 12px;
      object-fit: cover;
      margin-right: 1rem;
    }

    .qty-controls button {
      width: 26px;
      height: 26px;
      border-radius: 50%;
      border: none;
      background: #e7dfd7;
      cursor: pointer;
      font-size: 1rem;
      color: #4c3a2f;
    }

    .remove-btn {
      background: none;
      border: none;
      color: #c94a4a;
      font-size: 1.1rem;
      cursor: pointer;
    }

    .order-summary {
      background: #fff;
      width: 280px;
      padding: 1.4rem;
      border-radius: 14px;
      box-shadow: 0 3px 12px rgba(0,0,0,0.07);
    }

    .order-summary button {
      width: 100%;
      background: #6b4024;
      color: #fff;
      padding: 0.8rem;
      border-radius: 12px;
      border: none;
      cursor: pointer;
      font-weight: 500;
    }

    .order-summary button:hover {
      background: #4b2b18;
    }

    /* ORDERS */
    .order-card {
      background: #fff;
      padding: 1.5rem;
      border-radius: 14px;
      margin-bottom: 1rem;
      box-shadow: 0 3px 10px rgba(0,0,0,0.06);
      transition: 0.25s ease;
    }

    .order-card:hover {
      transform: translateY(-3px);
    }

    .progress-container {
      height: 6px;
      background: #e6ddd4;
      border-radius: 4px;
      margin-top: 0.8rem;
      overflow: hidden;
    }

    .progress-bar {
      height: 6px;
      background: linear-gradient(90deg, #6b4024, #c49a6c);
      width: 0%;
      transition: width 0.8s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Small responsive tweak */
    @media (max-width: 900px) {
      .cart-items { width: 100%; }
      .order-summary { width: 100%; }
    }
  </style>
</head>

<body>

  <header>
    <div class="logo">‚òï Mocha~Mist</div>

    <nav>
      <a onclick="showSection('menu')">Menu</a>
      <a onclick="showSection('cart')">Cart <span id="cartCount" class="cart-count">0</span></a>
      <a onclick="showSection('orders')">My Orders</a>
      <a href="index.html">Logout</a>
    </nav>
  </header>

  <!-- MENU -->
  <section id="menuSection">
    <h2>Our Menu</h2>
    <p class="subtitle">Explore our handcrafted, cloud-powered beverages</p>
    <div id="menuGrid" class="menu-grid"></div>
  </section>

  <!-- CART -->
  <section id="cartSection" style="display:none;">
    <h2>Your Cart</h2>
    <p class="subtitle">Review your items</p>

    <div class="cart-container">
      <div class="cart-items" id="cartItems"></div>

      <div class="order-summary">
        <div class="summary-box" style="display:flex;justify-content:space-between;margin-bottom:0.6rem;">
          <span>Subtotal:</span> <span id="subtotal">‚Çπ0.00</span>
        </div>
        <div class="summary-box" style="display:flex;justify-content:space-between;margin-bottom:0.6rem;">
          <span>Tax (8%):</span> <span id="tax">‚Çπ0.00</span>
        </div>
        <div class="summary-box" style="display:flex;justify-content:space-between;margin-bottom:1rem;">
          <strong>Total:</strong> <strong id="total">‚Çπ0.00</strong>
        </div>
        <button onclick="placeOrder()">Place Order ‚ûú</button>
      </div>
    </div>
  </section>

  <!-- ORDERS -->
  <section id="ordersSection" style="display:none;">
    <h2>Order Tracking</h2>
    <p class="subtitle">Track your coffee orders in real-time</p>
  </section>

  <footer style="text-align:center;padding:1rem;color:#8a7b6f;">
    ¬© 2025 Mocha~Mist ‚Äî All Rights Reserved
  </footer>

  <!-- Socket.IO client (CDN) -->
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

  <script>
    /**
     * COMPLETE FRONTEND LOGIC (connected to hosted backend)
     *
     * IMPORTANT:
     * - Replace API_BASE with your actual backend URL (e.g. https://mocha-backend.onrender.com)
     * - The backend must serve CORS and accept Authorization: Bearer <token>
     * - The backend must expose:
     *     GET  /api/menu
     *     POST /api/orders/create
     *     GET  /api/orders/mine
     *   and Socket.IO at the same origin
     */

    // ---------- CONFIG ----------
    const API_BASE = "https://YOUR_BACKEND_URL"; // <<-- REPLACE this with your real backend URL (no trailing slash)
    const MENU_URL = `${API_BASE}/api/menu`;
    const CREATE_ORDER_URL = `${API_BASE}/api/orders/create`;
    const MY_ORDERS_URL = `${API_BASE}/api/orders/mine`;

    // ---------- STATE ----------
    let menu = [];
    let cart = [];
    let orders = [];

    // token (expected to be stored after login)
    const token = localStorage.getItem("accessToken"); // change key if different

    const menuGrid = document.getElementById("menuGrid");
    const cartItems = document.getElementById("cartItems");
    const cartCount = document.getElementById("cartCount");

    // ---------- HELPER: show friendly message if token not found ----------
    if (!token) {
      // token missing ‚Äî user likely not logged in. You can redirect to login page if desired.
      console.warn("No access token found in localStorage under key 'accessToken'. Requests to protected endpoints will fail. If you use authentication, store token in localStorage after login.");
      // (We do not redirect automatically ‚Äî keep it optional)
    }

    // ---------- SOCKET.IO (realtime updates) ----------
    // connecting the socket to your hosted backend for realtime "order:update" or "order:new"
    const socket = io(API_BASE, {
      auth: { token }
    });

    socket.on("connect", () => {
      console.log("Socket connected:", socket.id);
    });

    socket.on("connect_error", (err) => {
      console.warn("Socket connect error:", err.message || err);
    });

    // receive order updates (customer-specific or broadcasted)
    socket.on("order:update", (updatedOrder) => {
      console.log("order:update", updatedOrder);
      const idx = orders.findIndex(o => o.id === updatedOrder.id);
      if (idx !== -1) {
        orders[idx] = updatedOrder;
        renderOrders();
      } else {
        // if this order belongs to current user, add it
        // note: backend should only emit to specific user room (user_<id>) but we keep safeguard
        if (updatedOrder.user_id && updatedOrder.user_id === getUserIdFromToken()) {
          orders.unshift(updatedOrder);
          renderOrders();
        }
      }
    });

    // optional: new orders broadcast (barista notif) ‚Äî ignore for customers
    socket.on("order:new", (order) => {
      console.log("order:new", order);
    });

    // ---------- UTIL: getUserIdFromToken (simple JWT decode) ----------
    function getUserIdFromToken() {
      if (!token) return null;
      try {
        const payload = token.split('.')[1];
        const decoded = JSON.parse(atob(payload.replace(/-/g, '+').replace(/_/g, '/')));
        return decoded?.id || decoded?.userId || decoded?.sub || null;
      } catch (e) {
        return null;
      }
    }

    // ---------- LOAD MENU ----------
    async function loadMenu() {
      try {
        const res = await fetch(MENU_URL);
        if (!res.ok) throw new Error(`Menu fetch failed (${res.status})`);
        const data = await res.json();
        // normalize data: backend may name fields differently (image/description)
        menu = data.map(item => ({
          id: item.id,
          name: item.name,
          price: item.price,
          description: item.description || item.desc || "",
          image: item.image || item.img || item.image_url || ""
        }));
        renderMenu();
      } catch (err) {
        console.error("Menu load error:", err);
        menuGrid.innerHTML = `<p style="color:#c94a4a;">Failed to load menu. Check backend URL and CORS.</p>`;
      }
    }

    // ---------- RENDER MENU ----------
    function renderMenu() {
      menuGrid.innerHTML = "";
      if (!menu || menu.length === 0) {
        menuGrid.innerHTML = `<p style="color:#7b6a58;">No menu items found.</p>`;
        return;
      }

      menu.forEach((item, i) => {
        const card = document.createElement("div");
        card.className = "coffee-card";

        const imgSrc = item.image && item.image.length > 5
                      ? item.image
                      : "https://images.unsplash.com/photo-1604908554022-9e5db3a4f4d8?q=80&w=1074&auto=format&fit=crop&ixlib=rb-4.0.0";

        card.innerHTML = `
          <img src="${imgSrc}" alt="${escapeHtml(item.name)}">
          <div class="details">
            <h3>${escapeHtml(item.name)} <span class="price">‚Çπ${item.price}</span></h3>
            <p>${escapeHtml(item.description)}</p>
            <button onclick="addToCart(${i})">+ Add to Cart</button>
          </div>
        `;

        menuGrid.appendChild(card);
      });
    }

    // ---------- ESCAPE HTML ----------
    function escapeHtml(text) {
      if (!text) return "";
      return text.replaceAll('&', '&amp;')
                 .replaceAll('<', '&lt;')
                 .replaceAll('>', '&gt;')
                 .replaceAll('"', '&quot;')
                 .replaceAll("'", '&#039;');
    }

    // ---------- CART MANAGEMENT ----------
    function addToCart(menuIndex) {
      const item = menu[menuIndex];
      if (!item) return;
      const existing = cart.find(c => c.id === item.id);
      if (existing) existing.qty += 1;
      else cart.push({ id: item.id, name: item.name, price: item.price, qty: 1, image: item.image });

      updateCart();
      // small unobtrusive toast behavior
      showToast(`${item.name} added to cart`);
    }

    function changeQty(i, delta) {
      if (!cart[i]) return;
      cart[i].qty += delta;
      if (cart[i].qty <= 0) cart.splice(i, 1);
      updateCart();
    }

    function removeItem(i) {
      cart.splice(i, 1);
      updateCart();
    }

    function updateCart() {
      cartCount.textContent = cart.reduce((a, b) => a + b.qty, 0);

      cartItems.innerHTML = "";
      let subtotal = 0;

      cart.forEach((item, idx) => {
        subtotal += item.price * item.qty;

        const div = document.createElement("div");
        div.className = "cart-item";

        div.innerHTML = `
          <img src="${escapeHtml(item.image || 'https://images.unsplash.com/photo-1604908554022-9e5db3a4f4d8?q=80&w=1074&auto=format&fit=crop&ixlib=rb-4.0.0')}" alt="${escapeHtml(item.name)}">
          <div style="flex-grow:1;">
            <h4>${escapeHtml(item.name)}</h4>
            <p>‚Çπ${item.price} each</p>
            <div class="qty-controls" style="display:flex;gap:0.5rem;align-items:center;margin-top:0.5rem;">
              <button onclick="changeQty(${idx}, -1)">‚àí</button>
              <span>${item.qty}</span>
              <button onclick="changeQty(${idx}, 1)">+</button>
            </div>
          </div>
          <strong>‚Çπ${(item.price * item.qty).toFixed(2)}</strong>
          <button class="remove-btn" onclick="removeItem(${idx})">üóëÔ∏è</button>
        `;

        cartItems.appendChild(div);
      });

      const taxAmount = subtotal * 0.08;
      const totalAmount = subtotal + taxAmount;

      document.getElementById("subtotal").textContent = `‚Çπ${subtotal.toFixed(2)}`;
      document.getElementById("tax").textContent = `‚Çπ${taxAmount.toFixed(2)}`;
      document.getElementById("total").textContent = `‚Çπ${totalAmount.toFixed(2)}`;
    }

    // small toast function
    function showToast(msg) {
      const el = document.createElement("div");
      el.textContent = msg;
      el.style.position = "fixed";
      el.style.right = "20px";
      el.style.bottom = "20px";
      el.style.background = "rgba(0,0,0,0.8)";
      el.style.color = "white";
      el.style.padding = "10px 14px";
      el.style.borderRadius = "10px";
      el.style.zIndex = 9999;
      document.body.appendChild(el);
      setTimeout(() => el.remove(), 2000);
    }

    // ---------- PLACE ORDER (POST) ----------
    async function placeOrder() {
      if (!token) {
        return alert("You must be logged in to place an order.");
      }
      if (cart.length === 0) return alert("Your cart is empty!");

      const items = cart.map(c => ({ id: c.id, name: c.name, qty: c.qty, price: c.price }));

      const subtotal = items.reduce((a, b) => a + b.price * b.qty, 0);
      const total = +(subtotal + subtotal * 0.08).toFixed(2);

      try {
        const res = await fetch(CREATE_ORDER_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}`
          },
          body: JSON.stringify({ items, total })
        });

        const data = await res.json();
        if (!res.ok) {
          const msg = data?.message || `Order failed (${res.status})`;
          console.error("Order create error:", data);
          return alert(msg);
        }

        showToast("Order placed successfully! ‚òï");
        // clear cart & update
        cart = [];
        updateCart();

        // reload user's orders and switch to orders view
        await loadMyOrders();
        showSection("orders");
      } catch (err) {
        console.error("Order create exception:", err);
        alert("Failed to place order. Check network and backend.");
      }
    }

    // ---------- LOAD MY ORDERS ----------
    async function loadMyOrders() {
      if (!token) {
        // If unauthenticated, show no orders but don't crash
        orders = [];
        renderOrders();
        return;
      }

      try {
        const res = await fetch(MY_ORDERS_URL, {
          headers: { "Authorization": `Bearer ${token}` }
        });

        if (!res.ok) throw new Error(`Orders fetch failed (${res.status})`);
        orders = await res.json();

        // convert DB timestamps to Date if necessary
        orders = orders.map(o => ({
          ...o,
          time: o.time || o.created_at || o.createdAt || o.time_created || new Date().toISOString()
        }));

        renderOrders();
      } catch (err) {
        console.error("My orders load error:", err);
        const orderSection = document.getElementById("ordersSection");
        orderSection.innerHTML = `<h2>Order Tracking</h2><p class="subtitle">Track your coffee orders in real-time</p>
          <p style="color:#c94a4a;">Failed to load your orders. If you're logged in, check backend/API or token.</p>`;
      }
    }

    // ---------- RENDER ORDERS ----------
    function renderOrders() {
      const orderSection = document.getElementById("ordersSection");

      orderSection.innerHTML = `<h2>My Orders</h2><p class="subtitle">Track your coffee orders</p>`;

      const sorted = (orders || []).slice().sort((a, b) => (b.id || 0) - (a.id || 0));

      if (!sorted.length) {
        orderSection.innerHTML += `<p style="text-align:center;color:#7b6a58;">No orders yet.</p>`;
        return;
      }

      sorted.forEach(order => {
        const div = document.createElement("div");
        div.className = "order-card";

        const itemsList = (order.items || []).map(it => `<li>${escapeHtml(it.name)} √ó${it.qty}</li>`).join("");

        const timeStr = order.time ? new Date(order.time).toLocaleString() : "";

        div.innerHTML = `
          <strong>Order #${order.id}</strong>
          <span style="float:right;color:${getStatusColor(order.status)};">${escapeHtml(order.status || "")}</span>
          <p style="color:#7b6a58;font-size:0.9rem;margin:0.5rem 0;">${timeStr}</p>

          <ul style="list-style:none;margin-left:0;padding-left:0;line-height:1.5;">
            ${itemsList}
          </ul>

          <p><strong>Total:</strong> ‚Çπ${order.total}</p>

          <div class="progress-container">
            <div class="progress-bar" style="width:${getStatusProgress(order.status)};"></div>
          </div>
        `;

        orderSection.appendChild(div);
      });
    }

    function getStatusProgress(status) {
      return status === "Preparing" ? "33%" :
             status === "Ready" ? "66%" :
             status === "Served" ? "100%" : "0%";
    }

    function getStatusColor(status) {
      return status === "Preparing" ? "#c9a34a" :
             status === "Ready" ? "#6b4024" :
             status === "Served" ? "green" : "#7b6a58";
    }

    // ---------- SECTION SWITCHER ----------
    function showSection(section) {
      document.getElementById("menuSection").style.display = section === "menu" ? "block" : "none";
      document.getElementById("cartSection").style.display = section === "cart" ? "block" : "none";
      document.getElementById("ordersSection").style.display = section === "orders" ? "block" : "none";

      if (section === "orders") loadMyOrders();
    }

    // ---------- INIT ----------
    // load menu and orders on page open
    (function init() {
      loadMenu();
      loadMyOrders();
      updateCart();
    })();

  </script>

</body>
</html>
